# aquarium
Aquarium of oekaki

## なにこれ
[oekaki](https://github.com/pelab2021/oekaki)で描いた絵を管理するWebシステムです。

## 環境構築
1. node.js v12.20.2を入れる

- Macの場合はnodenv、Windowsの場合はnodistを使うとnode.jsのバージョン管理を楽に行え、便利です。
ただこのシステムの運用にあたって途中でnodeのバージョンを変えることはないと思うので公式から単体を入れてきてもいいと思います。

2. これをcloneする
3. cloneしたディレクトリ内に移動し、nodeのバージョンを確認する
- `node -v`で確認できます。ここで`12.20.2`とでてきたらOKです。
4. パッケージを入れる
- `npm i`を実行することでnode_modulesというディレクトリが作られ、いっぱいパッケージが入ります。ちょっと時間がかかります。
- 多分警告とか出ると思うんですけどとりあえずスルーでOKです。
5. config.jsファイルを作る
- config.jsファイルを作成し、以下をコピペしてください。
```
module.exports = {
  dev: true,
  key: null,
  crt: null
}
```
- 本番環境の場合は、`dev`を`false`にして、`key`と`crt`に適切な場所を指定してください。
7. 起動する
- `npm run start`を実行してブラウザで`localhost:3000`にアクセスできたら成功です。

## ディレクトリ構成
<dl>
  <dt>bin/www</dt>
  <dd>システムを起動するファイルです。詳細は僕もわかっていません。~~本当は本番環境と開発環境で設定を変えたり、HTTPS化しなきゃいけないものだと思うんですけど、ユーザーからは見えないものにするのでとりあえずスルーします。セキュリティよくわからん~~ HPとの相互通信をするためには、HTTPS化しなくてはいけませんでした（HTTPとHTTPSとの相互通信はできない）。適当に安めのドメインを取得し、ホストゾーンを作成し、ネームサーバを設定します。うまいこと設定できたらそのドメイン名をLet's Encryptという無料でSSL証明書が作成できるサービスで用いて、秘密鍵ファイルと証明書ファイルを得ます。</dd>
  <dt>public</dt>
  <dd>cssとかフロント側のjavascriptを置いておくところです。</dd>
  <dt>routes</dt>
  <dd>ルーティングを担当します。本質はupload.jsです。詳細は後述</dd>
  <dt>views</dt>
  <dd>pugというhtmlを楽に書けるファイルがおかれています。先述のとおりユーザーからは見えないものにするので、主にデバッグ用に使うのだと思います。</dd>
  <dt>app.js</dt>
  <dd>ここでWebサイトに機能をいろいろ生やしています。</dd>
  <dt>temp</dt>
  <dd>oekakiでアップロードされた画像は最初にここに保存されます。github上で画像のやり取りが行われるのは望ましくないので、.gitignoreに指定されています。</dd>
  <dt>uploads</dt>
  <dd>承認済みのお絵描き画像が保存されるディレクトリです。github上で画像のやり取りが行われるのは望ましくないので、.gitignoreに指定されています。</dd>
</dl>

## 水族館の仕組み
- oekakiで描いた絵は、アップロードボタンを押すことでこのシステムの`temp`にお絵描き画像を渡します。まだ承認されていない画像たちです。
- POST通信の際、画像はフロントからbase64にエンコードされて送られているので、このシステムではそれをデコードして`temp`ディレクトリに置いています。
- `/tempList`にアクセスすることで、`temp`ディレクトリにある画像一覧を表示します。1つ1つの画像に承認ボタンと拒否ボタンがあります。
- 承認を押すと、その画像を`uploads`ディレクトリに移動します。拒否を押すと、その画像を削除します。
- 画像を泳がせたい場合は、そのページからこのシステムの`/uploadedList`に通信します。
- `/uploadedList`は、`uploads`ディレクトリに置かれている画像一覧をjson形式で返すので、取得できたjsonをフロント側のjavascriptでうまいこと処理することで画像を泳がせます。
- このシステム上では、`/aquarium`にアクセスすると画像が泳ぎます。その挙動は`public/javascripts/aquarium.js`に書かれています。
